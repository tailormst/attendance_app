{% extends 'base.html' %}
{% load attendance_extras %}

{% block title %}Attendance Report - Attendance Management System{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2><i class="bi bi-graph-up"></i> Attendance Report</h2>
            <p class="text-muted">View monthly attendance reports and analytics</p>
        </div>
    </div>

    <!-- Month/Year Selection -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-calendar"></i> Select Month & Year</h5>
                </div>
                <div class="card-body">
                    <form method="get" class="row g-3">
                        <div class="col-md-3">
                            <label for="month" class="form-label">Month</label>
                            <select class="form-select" id="month" name="month">
                                <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
                                <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
                                <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
                                <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
                                <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
                                <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
                                <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
                                <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
                                <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
                                <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
                                <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
                                <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="year" class="form-label">Year</label>
                            <select class="form-select" id="year" name="year">
                                <option value="2024" {% if year == 2024 %}selected{% endif %}>2024</option>
                                <option value="2025" {% if year == 2025 %}selected{% endif %}>2025</option>
                                <option value="2026" {% if year == 2026 %}selected{% endif %}>2026</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-search"></i> Generate Report
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <a href="{% url 'export_report' %}?month={{ month }}&year={{ year }}" class="btn btn-success">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-table"></i> Attendance Summary - 
                        {% if month == 1 %}January
                        {% elif month == 2 %}February
                        {% elif month == 3 %}March
                        {% elif month == 4 %}April
                        {% elif month == 5 %}May
                        {% elif month == 6 %}June
                        {% elif month == 7 %}July
                        {% elif month == 8 %}August
                        {% elif month == 9 %}September
                        {% elif month == 10 %}October
                        {% elif month == 11 %}November
                        {% elif month == 12 %}December
                        {% endif %} {{ year }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if summary_data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Employee Name</th>
                                        <th>Present Days</th>
                                        <th>Absent Days</th>
                                        <th>Leave Days</th>
                                        <th>Holiday Days</th>
                                        <th>Total Days</th>
                                        <th>Attendance %</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for data in summary_data %}
                                    <tr class="{% if data.percentage < 75 %}low-attendance{% endif %}">
                                        <td>
                                            <strong>{{ data.employee.name }}</strong>
                                            <br><small class="text-muted">{{ data.employee.emp_id }}</small>
                                        </td>
                                        <td><span class="badge bg-success">{{ data.present }}</span></td>
                                        <td><span class="badge bg-danger">{{ data.absent }}</span></td>
                                        <td><span class="badge bg-warning">{{ data.leave }}</span></td>
                                        <td><span class="badge bg-secondary">{{ data.holiday }}</span></td>
                                        <td><strong>{{ data.total_days }}</strong></td>
                                        <td>
                                            <span class="badge {% if data.percentage >= 90 %}bg-success{% elif data.percentage >= 75 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ data.percentage }}%
                                            </span>
                                        </td>
                                        <td>
                                            <a href="{% url 'employee_detail' data.employee.id %}?month={{ month }}&year={{ year }}" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-eye"></i> Details
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-graph-down display-1 text-muted"></i>
                            <h5 class="text-muted">No data found</h5>
                            <p class="text-muted">No attendance records found for the selected month and year.</p>
                            <p class="text-muted">Please mark attendance first or try a different month/year.</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    {% if summary_data %}
    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-bar-chart"></i> Attendance Overview</h5>
                </div>
                <div class="card-body">
                    <canvas id="attendanceChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="bi bi-pie-chart"></i> Status Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Chart data from Django
    const chartData = {{ chart_data|safe }};
    
    // Attendance Overview Chart
    if (chartData && chartData.labels.length > 0) {
        const ctx1 = document.getElementById('attendanceChart').getContext('2d');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: chartData.labels,
                datasets: [
                    {
                        label: 'Present',
                        data: chartData.present,
                        backgroundColor: '#28a745'
                    },
                    {
                        label: 'Absent',
                        data: chartData.absent,
                        backgroundColor: '#dc3545'
                    },
                    {
                        label: 'Leave',
                        data: chartData.leave,
                        backgroundColor: '#ffc107'
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
        
        // Status Distribution Chart
        const ctx2 = document.getElementById('statusChart').getContext('2d');
        const totalPresent = chartData.present.reduce((a, b) => a + b, 0);
        const totalAbsent = chartData.absent.reduce((a, b) => a + b, 0);
        const totalLeave = chartData.leave.reduce((a, b) => a + b, 0);
        
        new Chart(ctx2, {
            type: 'pie',
            data: {
                labels: ['Present', 'Absent', 'Leave'],
                datasets: [{
                    data: [totalPresent, totalAbsent, totalLeave],
                    backgroundColor: ['#28a745', '#dc3545', '#ffc107']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
</script>
{% endblock %}
